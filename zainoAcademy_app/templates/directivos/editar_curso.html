<!-- 
Nombre del archivo: editar_curso.html 
Descripción: Este archivo es un fomrulario de editra los cursos ya creados y de la lista de los estudiantes disponibles y ya guardados previamente
Autor: David Santiago Alfonso Guzman
Fecha de creación: 2025-04-18 
Última modificación: 2025-09-05
-->


{% extends 'base_directivos.html' %}
{% load static %}
{% block page_title %}Editar Curso{% endblock %}
{% block content %}
<link rel="stylesheet" href="{% static 'css/directivos/editar_cursoStyles.css' %}">

    <div class="action-buttons">
    <a href="{% url 'crear_curso' %}" class="btn btn-primary">Crear</a>
    <a href="{% url 'lista_cursos' %}" class="btn btn-secondary">Consultar</a>
    </div>

    <!-- Mostrar mensajes de Django -->
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }}">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}

    <h2 style="text-align:center;">Editar Curso</h2>

    <form class="form-layout" id="cursoForm">
    {% csrf_token %}
    
    <!-- Campo oculto con el ID del curso -->
    <input type="hidden" id="cursoId" value="{{ curso.Cur_id }}">

    <div class="column">
        <div class="form-group">
            <label for="nombreCurso">Nombre del Curso:</label>
            <input type="text" id="nombreCurso" value="{{ curso.Cur_nombre }}" required>
        </div>
        
        <div class="form-group">
            <label>Buscar Estudiantes:</label>
            <input type="search" 
                    class="search-box" 
                    id="buscarEstudiante">
        </div>

        <div class="form-group">
            <label>Estudiantes Disponibles:</label>
            <div class="estudiantes-container" id="estudiantesDisponibles">
                <!-- Se cargan dinámicamente -->
            </div>
        </div>
    </div>

    <div class="column">
        <div class="form-group">
            <label>Estudiantes Asignados al Curso:</label>
            <div class="estudiantes-container" id="estudiantesAsignados">
                <div class="no-estudiantes">Cargando estudiantes...</div>
            </div>
        </div>
        
        <div class="form-group">
            <label>Resumen:</label>
            <div class="resumen-container">
                <p>Total de estudiantes: <span id="totalEstudiantes">0</span></p>
            </div>
        </div>
    </div>

    <button type="button" class="submit-button" id="actualizarCursoBtn">
        Guardar Cambios
    </button>
    </form>

<!-- 
JS para ver la lista de estudiantes previmanete guardados
-->

<script>
document.addEventListener('DOMContentLoaded', function() {
    let estudiantesAsignados = []; // Array para mantener estudiantes asignados
    let todosLosEstudiantes = []; // Array con todos los estudiantes
    const cursoId = document.getElementById('cursoId').value;

    // Cargar estudiantes del curso y todos los estudiantes
    Promise.all([
        cargarEstudiantesDelCurso(),
        cargarTodosLosEstudiantes()
    ]).then(() => {
        actualizarListasEstudiantes();
        actualizarResumen();
    });

    // Buscador de estudiantes
    document.getElementById('buscarEstudiante').addEventListener('input', function() {
        const query = this.value.trim();
        if (query.length >= 2) {
            filtrarEstudiantes(query);
        } else {
            mostrarEstudiantesDisponibles();
        }
    });

    // Actualizar curso con estudiantes
    document.getElementById('actualizarCursoBtn').addEventListener('click', function() {
        const nombreCurso = document.getElementById('nombreCurso').value.trim();
        
        if (!nombreCurso) {
            alert('Por favor ingresa el nombre del curso');
            return;
        }

        actualizarCursoConEstudiantes(nombreCurso, estudiantesAsignados);
    });

    function cargarEstudiantesDelCurso() {
        return fetch(`/curso/${cursoId}/estudiantes/`)
            .then(response => response.json())
            .then(data => {
                estudiantesAsignados = data;
                console.log('Estudiantes del curso cargados:', estudiantesAsignados);
            })
            .catch(error => {
                console.error('Error cargando estudiantes del curso:', error);
            });
    }

    function cargarTodosLosEstudiantes() {
        return fetch('/buscar_estudiantes/?q=')
            .then(response => response.json())
            .then(data => {
                todosLosEstudiantes = data;
                console.log('Todos los estudiantes cargados:', todosLosEstudiantes.length);
            })
            .catch(error => {
                console.error('Error cargando todos los estudiantes:', error);
            });
    }

    function mostrarEstudiantesDisponibles() {
        const disponibles = todosLosEstudiantes.filter(est => 
            !estudiantesAsignados.find(asig => asig.id === est.id)
        );
        renderizarEstudiantes(disponibles, 'estudiantesDisponibles', false);
    }

    function filtrarEstudiantes(query) {
        fetch(`/buscar_estudiantes/?q=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                const disponibles = data.filter(est => 
                    !estudiantesAsignados.find(asig => asig.id === est.id)
                );
                renderizarEstudiantes(disponibles, 'estudiantesDisponibles', false);
            })
            .catch(error => {
                console.error('Error en búsqueda:', error);
            });
    }

    function renderizarEstudiantes(estudiantes, containerId, esAsignado) {
        const container = document.getElementById(containerId);
        
        if (estudiantes.length === 0) {
            container.innerHTML = '<div class="no-estudiantes">No hay estudiantes para mostrar</div>';
            return;
        }

        container.innerHTML = estudiantes.map(estudiante => `
            <div class="estudiante-item ${esAsignado ? 'estudiante-asignado' : ''}" data-id="${estudiante.id}">
                <div class="estudiante-info">
                    <div class="estudiante-nombre">${estudiante.nombre}</div>
                    <div class="estudiante-documento">Doc: ${estudiante.documento}</div>
                </div>
                <button type="button" 
                        class="${esAsignado ? 'btn-quitar' : 'btn-asignar'}" 
                        onclick="${esAsignado ? 'quitarEstudiante' : 'asignarEstudiante'}(${estudiante.id})">
                    ${esAsignado ? 'Quitar' : 'Asignar'}
                </button>
            </div>
        `).join('');
    }

    window.asignarEstudiante = function(estudianteId) {
        const estudiante = todosLosEstudiantes.find(est => est.id === estudianteId);
        if (estudiante && !estudiantesAsignados.find(asig => asig.id === estudianteId)) {
            estudiantesAsignados.push(estudiante);
            actualizarListasEstudiantes();
            actualizarResumen();
        }
    }

    window.quitarEstudiante = function(estudianteId) {
        estudiantesAsignados = estudiantesAsignados.filter(est => est.id !== estudianteId);
        actualizarListasEstudiantes();
        actualizarResumen();
    }

    function actualizarListasEstudiantes() {
        mostrarEstudiantesDisponibles();
        renderizarEstudiantes(estudiantesAsignados, 'estudiantesAsignados', true);
    }

    function actualizarResumen() {
        document.getElementById('totalEstudiantes').textContent = estudiantesAsignados.length;
    }

    function actualizarCursoConEstudiantes(nombre, estudiantes) {
        const formData = new FormData();
        formData.append('Cur_nombre', nombre);
        
        estudiantes.forEach(est => {
            formData.append('estudiantes[]', est.id);
        });

        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
        if (csrfToken) {
            formData.append('csrfmiddlewaretoken', csrfToken);
        }

        fetch(`/curso/actualizar/${cursoId}/`, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`Curso "${nombre}" actualizado exitosamente con ${estudiantes.length} estudiantes`);
                window.location.href = '/curso/lista/';
            } else {
                alert('Error al actualizar el curso: ' + (data.error || 'Error desconocido'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al actualizar el curso. Revisa la consola para más detalles.');
        });
    }
});
</script>

{% endblock %}