<!-- 
Nombre del archivo: crear_acudiente.html 
Descripción: Este archivo es un fomrulario de la informacion adicional de los acudientes y la lista de los estudiantes
Autor: David Santiago Alfonso Guzman
Fecha de creación: 2025-04-18 
Última modificación: 2025-09-07
-->


{% extends 'base_directivos.html' %}
{% load static %}
{% block page_title %}Registrar Acudiente{% endblock %}
{% block content %}
<link rel="stylesheet" href="{% static 'css/directivos/maticulaStyles.css' %}">

<!-- Mostrar mensajes de Django -->
{% if messages %}
    {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">
            {{ message }}
        </div>
    {% endfor %}
{% endif %}

<h2 style="text-align:center;">Registrar Acudiente para: {{ usuario.Us_nombre }}</h2>

<form class="form-layout" id="acudienteForm">
{% csrf_token %}
<input type="hidden" id="usuarioId" value="{{ usuario.Us_id }}">

<div class="column">    
    <div class="form-group">
        <label>Buscar Estudiantes:</label>
        <input type="search" 
                class="search-box" 
                id="buscarEstudiante"
                placeholder="Buscar por nombre o documento">
    </div>

    <div class="form-group">
        <label>Estudiantes Disponibles:</label>
        <div class="estudiantes-container" id="estudiantesDisponibles">
            <!-- Se cargan dinámicamente -->
        </div>
    </div>
</div>

<div class="column">
    <div class="form-group">
        <label>Estudiantes Asignados al Acudiente:</label>
        <div class="estudiantes-container" id="estudiantesAsignados">
            <div class="no-estudiantes">No hay estudiantes asignados</div>
        </div>
    </div>
    
    <div class="form-group">
        <label>Información del Acudiente:</label>
        <div class="resumen-container">
            <p><strong>Usuario:</strong> {{ usuario.Us_nombre }}</p>
            <p><strong>Correo:</strong> {{ usuario.correo }}</p>
            <p><strong>Documento:</strong> {{ usuario.documento }}</p>
            <p>Total de estudiantes: <span id="totalEstudiantes">0</span></p>
        </div>
    </div>
</div>

<button type="button" class="submit-button" id="crearAcudienteBtn">
    Registrar Acudiente
</button>
</form>

<!-- JS para lista de estudiantes -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    let estudiantesAsignados = []; // CAMBIO: Array para múltiples estudiantes
    let todosLosEstudiantes = []; // Array con todos los estudiantes

    // Cargar todos los estudiantes al inicio
    cargarEstudiantes();

    // Buscador de estudiantes
    document.getElementById('buscarEstudiante').addEventListener('input', function() {
        const query = this.value.trim();
        if (query.length >= 2) {
            filtrarEstudiantes(query);
        } else {
            mostrarTodosLosEstudiantes();
        }
    });

    // Registrar acudiente con estudiantes
    document.getElementById('crearAcudienteBtn').addEventListener('click', function() {        
        if (estudiantesAsignados.length === 0) {
            alert('Por favor asigna al menos un estudiante al acudiente');
            return;
        }

        const usuarioId = document.getElementById('usuarioId').value;
        registrarAcudienteConEstudiantes(usuarioId, estudiantesAsignados);
    });

    function cargarEstudiantes() {
        fetch('/buscar_estudiantes/?q=')
            .then(response => response.json())
            .then(data => {
                todosLosEstudiantes = data;
                mostrarTodosLosEstudiantes();
            })
            .catch(error => {
                console.error('Error cargando estudiantes:', error);
                document.getElementById('estudiantesDisponibles').innerHTML = 
                    '<div class="no-estudiantes">Error cargando estudiantes</div>';
            });
    }

    function mostrarTodosLosEstudiantes() {
        const disponibles = todosLosEstudiantes.filter(est => 
            !estudiantesAsignados.find(asig => asig.id === est.id)
        );
        renderizarEstudiantes(disponibles, 'estudiantesDisponibles', false);
    }

    function filtrarEstudiantes(query) {
        fetch(`/buscar_estudiantes/?q=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                const disponibles = data.filter(est => 
                    !estudiantesAsignados.find(asig => asig.id === est.id)
                );
                renderizarEstudiantes(disponibles, 'estudiantesDisponibles', false);
            })
            .catch(error => {
                console.error('Error en búsqueda:', error);
            });
    }

    function renderizarEstudiantes(estudiantes, containerId, esAsignado) {
        const container = document.getElementById(containerId);
        
        if (estudiantes.length === 0) {
            container.innerHTML = '<div class="no-estudiantes">No hay estudiantes para mostrar</div>';
            return;
        }

        container.innerHTML = estudiantes.map(estudiante => `
            <div class="estudiante-item ${esAsignado ? 'estudiante-asignado' : ''}" data-id="${estudiante.id}">
                <div class="estudiante-info">
                    <div class="estudiante-nombre">${estudiante.nombre}</div>
                    <div class="estudiante-documento">Doc: ${estudiante.documento}</div>
                </div>
                <button type="button" 
                        class="${esAsignado ? 'btn-quitar' : 'btn-asignar'}" 
                        onclick="${esAsignado ? 'quitarEstudiante' : 'asignarEstudiante'}(${estudiante.id})">
                    ${esAsignado ? 'Quitar' : 'Asignar'}
                </button>
            </div>
        `).join('');
    }

    window.asignarEstudiante = function(estudianteId) {
        const estudiante = todosLosEstudiantes.find(est => est.id === estudianteId);
        if (estudiante && !estudiantesAsignados.find(asig => asig.id === estudianteId)) {
            estudiantesAsignados.push(estudiante);
            actualizarListasEstudiantes();
            actualizarResumen();
        }
    }

    window.quitarEstudiante = function(estudianteId) {
        estudiantesAsignados = estudiantesAsignados.filter(est => est.id !== estudianteId);
        actualizarListasEstudiantes();
        actualizarResumen();
    }

    function actualizarListasEstudiantes() {
        // Actualizar lista de disponibles
        const disponibles = todosLosEstudiantes.filter(est => 
            !estudiantesAsignados.find(asig => asig.id === est.id)
        );
        renderizarEstudiantes(disponibles, 'estudiantesDisponibles', false);
        
        // Actualizar lista de asignados
        renderizarEstudiantes(estudiantesAsignados, 'estudiantesAsignados', true);
    }

    function actualizarResumen() {
        document.getElementById('totalEstudiantes').textContent = estudiantesAsignados.length;
    }

    function registrarAcudienteConEstudiantes(usuarioId, estudiantes) {
        const formData = new FormData();
        formData.append('usuario_id', usuarioId);
        
        // CAMBIO: Enviar múltiples estudiantes
        estudiantes.forEach(est => {
            formData.append('estudiantes[]', est.id);
        });

        // Obtener el token CSRF
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                            document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
        
        if (csrfToken) {
            formData.append('csrfmiddlewaretoken', csrfToken);
        }

        fetch('/crear_acudiente_con_estudiantes/', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`Acudiente registrado exitosamente con ${estudiantes.length} estudiantes`);
                window.location.href = '/usuario/'; // Redirigir a la lista
            } else {
                alert('Error al registrar el acudiente: ' + (data.error || 'Error desconocido'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al registrar el acudiente.');
        });
    }
});
</script>

{% endblock %}