{% extends 'base_directivos.html' %}
{% load static %}
{% block page_title %}Crear Curso{% endblock %}
{% block content %}
<link rel="stylesheet" href="{% static 'css/directivos/maticulaStyles.css' %}">

<div class="action-buttons">
  <a href="{% url 'crear_curso' %}" class="btn btn-primary">Crear</a>
  <a href="{% url 'lista_cursos' %}" class="btn btn-secondary">Consultar</a>
</div>

<!-- Mostrar mensajes de Django -->
{% if messages %}
    {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">
            {{ message }}
        </div>
    {% endfor %}
{% endif %}



<form class="form-layout" id="cursoForm">
  {% csrf_token %}

  <div class="column">
    <div class="form-group">
        <label for="nombreCurso">Nombre del Curso:</label>
        <input type="text" id="nombreCurso"  required>
    </div>
    
    <div class="form-group">
        <label>Buscar Estudiantes:</label>
        <input type="search" 
                class="search-box" 
                
                id="buscarEstudiante">
        </div>

    <div class="form-group">
        <label>Estudiantes Disponibles:</label>
        <div class="estudiantes-container" id="estudiantesDisponibles">
            <!-- Se cargan dinámicamente -->
        </div>
    </div>
    </div>

    <div class="column">
    <div class="form-group">
        <label>Estudiantes Asignados al Curso:</label>
        <div class="estudiantes-container" id="estudiantesAsignados">
            <div class="no-estudiantes">No hay estudiantes asignados</div>
        </div>
    </div>
    
    <div class="form-group">
        <label>Resumen:</label>
        <div class="resumen-container">
            <p>Total de estudiantes: <span id="totalEstudiantes">0</span></p>
        </div>
    </div>
  </div>

  <button type="button" class="submit-button" id="crearCursoBtn">
    Crear Curso con Estudiantes
  </button>
</form>

<style>
/* Estilos adicionales específicos para curso */
.estudiantes-container {
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 15px;
    min-height: 300px;
    max-height: 400px;
    overflow-y: auto;
    background: #f8f9fa;
}

.search-box {
    width: 100%;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 5px;
    font-size: 14px;
}

.estudiante-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px;
    margin: 5px 0;
    background: white;
    border-radius: 5px;
    border-left: 4px solid #1e91d6;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.estudiante-asignado {
    border-left-color: #4a4063;
}

.estudiante-info {
    flex-grow: 1;
}

.estudiante-nombre {
    font-weight: 600;
    color: #333;
    font-size: 14px;
}

.estudiante-documento {
    font-size: 12px;
    color: #666;
}

.btn-asignar, .btn-quitar {
    padding: 6px 12px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
    font-weight: 500;
    transition: background-color 0.2s;
}

.btn-asignar {
    background: #1e91d6;
    color: white;
}

.btn-asignar:hover {
    background: #1e91d6ff;
}

.btn-quitar {
    background: #4a4063;
    color: white;
}

.btn-quitar:hover {
    background: #4a4063;
}

.no-estudiantes {
    text-align: center;
    color: #666;
    font-style: italic;
    padding: 40px 20px;
}

.resumen-container {
    background: #e9ecef;
    padding: 15px;
    border-radius: 8px;
    border: 1px solid #dee2e6;
}

.resumen-container p {
    margin: 0;
    font-weight: 500;
    color: #495057;
}

#totalEstudiantes {
    color: #1e91d6;
    font-weight: 600;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let estudiantesAsignados = []; // Array para mantener estudiantes asignados
    let todosLosEstudiantes = []; // Array con todos los estudiantes

    // Cargar todos los estudiantes al inicio
    cargarEstudiantes();

    // Buscador de estudiantes
    document.getElementById('buscarEstudiante').addEventListener('input', function() {
        const query = this.value.trim();
        if (query.length >= 2) {
            filtrarEstudiantes(query);
        } else {
            mostrarTodosLosEstudiantes();
        }
    });

    // Crear curso con estudiantes
    document.getElementById('crearCursoBtn').addEventListener('click', function() {
        const nombreCurso = document.getElementById('nombreCurso').value.trim();
        
        if (!nombreCurso) {
            alert('Por favor ingresa el nombre del curso');
            return;
        }

        if (estudiantesAsignados.length === 0) {
            alert('Por favor asigna al menos un estudiante al curso');
            return;
        }

        crearCursoConEstudiantes(nombreCurso, estudiantesAsignados);
    });

    function cargarEstudiantes() {
        fetch('/buscar_estudiantes/?q=')
            .then(response => response.json())
            .then(data => {
                todosLosEstudiantes = data;
                mostrarTodosLosEstudiantes();
            })
            .catch(error => {
                console.error('Error cargando estudiantes:', error);
                document.getElementById('estudiantesDisponibles').innerHTML = 
                    '<div class="no-estudiantes">Error cargando estudiantes</div>';
            });
    }

    function mostrarTodosLosEstudiantes() {
        const disponibles = todosLosEstudiantes.filter(est => 
            !estudiantesAsignados.find(asig => asig.id === est.id)
        );
        renderizarEstudiantes(disponibles, 'estudiantesDisponibles', false);
    }

    function filtrarEstudiantes(query) {
        fetch(`/buscar_estudiantes/?q=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                const disponibles = data.filter(est => 
                    !estudiantesAsignados.find(asig => asig.id === est.id)
                );
                renderizarEstudiantes(disponibles, 'estudiantesDisponibles', false);
            })
            .catch(error => {
                console.error('Error en búsqueda:', error);
            });
    }

    function renderizarEstudiantes(estudiantes, containerId, esAsignado) {
        const container = document.getElementById(containerId);
        
        if (estudiantes.length === 0) {
            container.innerHTML = '<div class="no-estudiantes">No hay estudiantes para mostrar</div>';
            return;
        }

        container.innerHTML = estudiantes.map(estudiante => `
            <div class="estudiante-item ${esAsignado ? 'estudiante-asignado' : ''}" data-id="${estudiante.id}">
                <div class="estudiante-info">
                    <div class="estudiante-nombre">${estudiante.nombre}</div>
                    <div class="estudiante-documento">Doc: ${estudiante.documento}</div>
                </div>
                <button type="button" 
                        class="${esAsignado ? 'btn-quitar' : 'btn-asignar'}" 
                        onclick="${esAsignado ? 'quitarEstudiante' : 'asignarEstudiante'}(${estudiante.id})">
                    ${esAsignado ? 'Quitar' : 'Asignar'}
                </button>
            </div>
        `).join('');
    }

    window.asignarEstudiante = function(estudianteId) {
        const estudiante = todosLosEstudiantes.find(est => est.id === estudianteId);
        if (estudiante && !estudiantesAsignados.find(asig => asig.id === estudianteId)) {
            estudiantesAsignados.push(estudiante);
            actualizarListasEstudiantes();
            actualizarResumen();
        }
    }

    window.quitarEstudiante = function(estudianteId) {
        estudiantesAsignados = estudiantesAsignados.filter(est => est.id !== estudianteId);
        actualizarListasEstudiantes();
        actualizarResumen();
    }

    function actualizarListasEstudiantes() {
        // Actualizar lista de disponibles
        const disponibles = todosLosEstudiantes.filter(est => 
            !estudiantesAsignados.find(asig => asig.id === est.id)
        );
        renderizarEstudiantes(disponibles, 'estudiantesDisponibles', false);
        
        // Actualizar lista de asignados
        renderizarEstudiantes(estudiantesAsignados, 'estudiantesAsignados', true);
    }

    function actualizarResumen() {
        document.getElementById('totalEstudiantes').textContent = estudiantesAsignados.length;
    }

    function crearCursoConEstudiantes(nombre, estudiantes) {
        const formData = new FormData();
        formData.append('Cur_nombre', nombre);
        
        estudiantes.forEach(est => {
            formData.append('estudiantes[]', est.id);
        });

        // Obtener el token CSRF
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                            document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
        
        if (csrfToken) {
            formData.append('csrfmiddlewaretoken', csrfToken);
        }

        fetch('/crear_curso_con_estudiantes/', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`Curso "${nombre}" creado exitosamente con ${estudiantes.length} estudiantes`);
                window.location.href = '/curso/lista/'; // Redirigir a la lista
            } else {
                alert('Error al crear el curso: ' + (data.error || 'Error desconocido'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al crear el curso. Revisa la consola para más detalles.');
        });
    }
});
</script>

{% endblock %}