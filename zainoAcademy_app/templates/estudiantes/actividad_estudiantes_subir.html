{% extends "estudiantes/base.html" %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/estudiantes/actividad_estudiantes_subir.css' %}">
{% endblock %}

{% block mockUp %}
<div class="contenido">

    <div class="volver-container">
        <a href="{% url 'actividades_estudiantes' periodo.Per_id materia.Mtr_id %}" class="btn-volver">
            ‚Üê Volver
        </a>
    </div>

    <h1>{{ actividad.Act_nombre }}</h1>

    <div class="seccion-boxes">
        <div class="seccion 
            {% if entrega and entrega.Act_calificacion %}
                estado-calificado
            {% elif entrega and entrega.archivos.exists %}
                estado-entregado
            {% else %}
                estado-sin-entregar
            {% endif %}">
            <p class="subtitulo">Estado</p>
            <p class="texto">
                {% if entrega and entrega.Act_calificacion %}
                    Calificado <span class="chulito-verde">‚úî</span>
                {% elif entrega and entrega.archivos.exists %}
                    Entregado
                {% else %}
                    Sin entregar
                {% endif %}
            </p>
        </div>

        <div class="seccion">
            <p class="subtitulo">Fecha l√≠mite</p>
            <p class="texto">{{ actividad.Act_fechaLimite }}</p>
        </div>

        <div class="seccion">
            <p class="subtitulo">Nota</p>
            <p class="texto">
                {% if entrega and entrega.Act_calificacion %}
                    {{ entrega.Act_calificacion }}
                {% else %}
                    No calificada a√∫n
                {% endif %}
            </p>
        </div>


        <!-- Nueva secci√≥n para comentario del profesor -->
        {% if entrega and entrega.Act_comentario %}
        <div class="seccion seccion-comentario">
            <p class="subtitulo">Comentario del Profesor</p>
            <p class="texto comentario-profesor">{{ entrega.Act_comentario }}</p>
        </div>
        {% endif %}

        <!-- Secci√≥n para archivo del profesor si existe -->
        {% if actividad.Act_Archivo_Profesor %}
        <div class="seccion seccion-archivo-profesor">
            <p class="subtitulo">Material del Profesor</p>
            <div class="archivo-profesor-container">
                <a href="{{ actividad.Act_Archivo_Profesor.url }}" target="_blank" class="link-archivo-profesor">
                    Ver archivo profesor
                </a>
            </div>
        </div>
        {% endif %}

        <div class="seccion">
            <p class="subtitulo">Descripci√≥n</p>
            <p class="texto">{{ actividad.Act_descripcion }}</p>
        </div>
    </div>

    <hr>

    <div class="seccion">
        <p class="subtitulo">Subir Actividad</p>

        {% if mensaje_exito %}
            <div class="mensaje-exito" id="mensaje-exito">{{ mensaje_exito }}</div>
            <script>
                setTimeout(() => {
                    const msg = document.getElementById("mensaje-exito");
                    if (msg) {
                        msg.style.transition = "opacity 0.5s ease";
                        msg.style.opacity = "0";
                        setTimeout(() => msg.remove(), 500);
                    }
                }, 3000); 
            </script>
        {% endif %}

        <form method="post" enctype="multipart/form-data" class="form-subida">
            {% csrf_token %}

            {% if entrega and entrega.archivos.exists %}
                <div class="archivo-subido">
                    <p>Archivos existentes:</p>
                    {% for archivo in entrega.archivos.all %}
                    <div id="archivo-{{ archivo.id }}">
                        üìé <a href="{{ archivo.archivo.url }}" target="_blank">{{ archivo.archivo.name|truncatechars:30 }}</a>
                        <button type="button" class="btn-eliminar" data-id="{{ archivo.id }}" {% if fecha_vencida %}disabled{% endif %}>‚ùå</button>
                    </div>
                    {% endfor %}
                </div>
            {% endif %}

            <input type="file" name="archivos_estudiante[]" id="archivo" multiple {% if fecha_vencida %}disabled{% endif %}>
            <div id="archivos-lista"></div> 

            <button type="submit" class="btn-subir" {% if fecha_vencida %}disabled{% endif %}>
                Subir Archivos
            </button>
            {% if fecha_vencida %}
                <p style="color:red; margin-top:5px;">La fecha l√≠mite ya pas√≥, no se pueden subir m√°s archivos.</p>
            {% endif %}
        </form>
    </div>
</div>

<script>
const inputArchivo = document.getElementById("archivo");
const listaArchivos = document.getElementById("archivos-lista");
let archivosSeleccionados = [];

// Cada vez que se seleccionan archivos nuevos
inputArchivo.addEventListener("change", (e) => {
    // Agregar los nuevos archivos a la lista existente
    archivosSeleccionados = archivosSeleccionados.concat(Array.from(e.target.files));
    renderLista();
    updateInputFiles();
});

function renderLista() {
    listaArchivos.innerHTML = "";
    archivosSeleccionados.forEach((archivo, index) => {
        const div = document.createElement("div");
        div.textContent = archivo.name + " ";
        
        const btn = document.createElement("button");
        btn.type = "button";
        btn.textContent = "‚ùå";
        btn.addEventListener("click", () => {
            archivosSeleccionados.splice(index, 1);
            renderLista();
            updateInputFiles();
        });

        div.appendChild(btn);
        listaArchivos.appendChild(div);
    });
}

function updateInputFiles() {
    const dataTransfer = new DataTransfer();
    archivosSeleccionados.forEach(file => dataTransfer.items.add(file));
    inputArchivo.files = dataTransfer.files;
}

document.addEventListener("DOMContentLoaded", () => {
    document.querySelector(".archivo-subido")?.addEventListener("click", function(e) {
        if (e.target.classList.contains("btn-eliminar")) {
            const btn = e.target;
            const archivoId = btn.dataset.id;

            fetch("{% url 'eliminar_archivo' %}", {  
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": "{{ csrf_token }}"
                },
                body: JSON.stringify({ "archivo_id": archivoId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.exito) {
                    document.getElementById(`archivo-${archivoId}`).remove();
                } else {
                    alert(data.error || "No se pudo eliminar el archivo");
                }
            })
            .catch(err => {
                console.error(err);
                alert("Error al comunicarse con el servidor");
            });
        }
    });
});

</script>

{% endblock %}